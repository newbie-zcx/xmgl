<div class="layui-card">
    <div class="layui-row layui-card-header">
        <div class="layui-col-md1" style="width: 28px;">
            <span class="big_font" style="width: 16px;height: 16px;font-size: 18px;padding: 0.1em;">评</span>
        </div>
        <div class="layui-col-md11" style="font-size: 16px; color: #666666;text-align: left;">
            我要回复
        </div>
    </div>
    <div class="layui-card-body">
        <div class="layui-form">
            <div>
                <div>
                    <a href="#" id="fileUpload" style="color:#4bbc8b"><img src="/static/assets/images/fujian.png" style="color:#4bbc8b" />添加附件  </a>  (最大为20M)
                </div>
                <div id="layui-upload-list" name="layui-upload-list" class="layui-upload-list">
                </div>
            </div>
            <div class="layui-form container">
                <div id="editor" name="editor">
                </div>
                <div class="layui-input-block" style="text-align: right;">
                    <input type="radio" name="shiro" value="公开" title="公开" checked>
                    <input type="radio" name="shiro" value="隐私" title="隐私">
                    <button class="layui-btn layui-btn-radius layui-btn-primary" lay-filter="submitEdit" lay-submit>发送</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 富文本编辑器 -->
<script>
    var E = window.wangEditor;
    var editor = new E('#editor');
    // 设置图片上传的type的参数
    editor.customConfig.uploadFileName = "file";
    // 设置图片上传接口
    editor.customConfig.uploadImgServer = '/system/file/uploadFile';

    //自定义上传图片事件
    editor.customConfig.uploadImgHooks = {
        before: function (xhr, editor, files) {

        },
        success: function (xhr, editor, result) {

        },
        fail: function (xhr, editor, result) {
            alert("上传失败,原因是" + result);
        },
        error: function (xhr, editor) {
            alert("上传出错");
        },
        timeout: function (xhr, editor) {
            alert("上传超时");
        },
        customInsert: function (insertImg, result, editor) {
            /**
             * 图片上传并返回结果，自定义插入图片的事件，而不是编辑器自动插入图片
             * insertImg 是插入图片的函数，editor 是编辑器对象，result 是服务器端返回的结果，必须是一个 JSON 格式字符串
             */
            var url = "/system/file/view?fileId="+result.msg;
            insertImg(url)
        }
    };
    //开启debug模式
    editor.customConfig.debug = true;
    // 关闭粘贴内容中的样式
    editor.customConfig.pasteFilterStyle = false;
    // 忽略粘贴内容中的图片
    editor.customConfig.pasteIgnoreImg = true;

    // 自定义菜单配置
    editor.customConfig.menus = [
        'head',  // 标题
        'bold',  // 粗体
        'fontSize',  // 字号
        'fontName',  // 字体
        'italic',  // 斜体
        'underline',  // 下划线
        'strikeThrough',  // 删除线
        'foreColor',  // 文字颜色
        'backColor',  // 背景颜色
        'link',  // 插入链接
        'list',  // 列表
        'justify',  // 对齐方式
        'quote',  // 引用
        'emoticon',  // 表情
        'image',  // 插入图片
        'undo',  // 撤销
        'redo'  // 重复
    ];

    // 隐藏tab中网络图片功能
    editor.customConfig.showLinkImg = false;
    editor.create();
</script>

<!-- 文件上传与预览 -->
<script>
    layui.use(['upload'], function () {
        var $ = layui.$;
        var upload = layui.upload;

        <!-- 富文本上传与预览-->
        upload.render({
            elem: '#fileUpload',
            url: '/system/file/upload/multi/file',
            accept: 'file',
            multiple: true,
            done: function (res) {
                var code = res.code;
                if(code == '200'){
                    for(var i=0; i<res.data.length; i++){
                        var dataValue = res.data[i];
                        var url = "http://127.0.0.1:8088/upload/wlyz/"+dataValue.filename;
                        url = encodeURIComponent(url);
                        var windowShow = 'http://127.0.0.1:8012/onlinePreview?url='+url;
                        var windowShowBlank = "<a class='btn btn-default' id='"+dataValue.id+"' target='_blank' href="+windowShow+">"+dataValue.sourceName+"</a>";
                        $("#layui-upload-list").append(windowShowBlank).append("<i id='"+dataValue.id+"_img' class='layui-icon layui-icon-close'></i>");
                    }
                }
            }
        });
        <!-- 删除附件事件 -->
        $(document).on('click',".layui-icon-close",function() {
            var img_id = this.id;
            var div_id = img_id.replace('_img','');
            $('#'+img_id).remove();
            $('#'+div_id).remove();
        });
    });
</script>

<!-- 富文本提交 -->
<script>
    layui.use(['layer', 'form'], function (){
        var $ = layui.$;
        var form = layui.form;
        var layer = layui.layer;

        form.on('submit(submitEdit)', function (obj) {
            console.log("form");
            var replyText = editor.txt.text();
            if (null == replyText || "" == replyText || undefined == replyText) {
                alert("请添加评论内容!");
                return;
            }
            var issueId = $("#issueId").val();
            var replyDesc = editor.txt.html();
            var showLevel = $("input[name='shiro']:checked").val();
            var child = $("#layui-upload-list").children();
            var size = child.size();
            var fileList = [];
            var fileValue;
            for (var ix = 0; ix < size; ix++) {
                console.log(child.eq(ix));
                /* 以这种方式判断是否标签 */
                if (ix % 2 == 0) {
                    fileList[ix] = child.eq(ix).attr("id");
                }
            };

            fileValue = fileList.join(',');
            layer.load(2);

            var toReplyUserId = $("#toReplyUserId").val();
            var toReplyUserName = $("#issueName").val();

            var dataValue = {
                'issueId': issueId,
                'replyDesc': replyDesc,
                'showLevel': showLevel,
                'toReplyUserId': toReplyUserId,
                'toReplyUserName': toReplyUserName,
                'fileList': fileValue
            };
            console.log('dataValue = ' + dataValue);
            addReply(dataValue);
        });

        function addReply(dataValue) {
            $.ajax({
                url: '/discuss/reply/add',
                type: 'POST',
                data: dataValue,
                success: function (data) {
                    layer.closeAll('loading');
                    if (data.code == 200) {
                        location.reload();
                        top.layer.msg(data.msg, {icon: 1});
                        // 关闭当前iframe弹出层
                        parent.layer.close(parent.layer.getFrameIndex(window.name));
                    } else {
                        top.layer.msg(data.msg, {icon: 2});
                    }
                }
            });
        };
    });
</script>
